```{r imports}
library(tidyverse)
library(tidycensus)
library(fpp3)

files <- list.files("downloads", full.names = TRUE)
homicide_data <- tibble(series = c(), month = c(), homicides = c(), ori = c())

for(file_path in files){
  temp_file <- read.csv(file_path)|> slice(-2) |> # slice off the second junk row
    pivot_longer(cols = starts_with("X"), names_to = "month", values_to = "homicides")|> # pivot
    mutate(ori =  str_split(file_path, "[/.]")[[1]][2])|> # name ori column the ori from the filepath
    mutate(month = my(sub("^X", "", month)))|> # month year conversion
    mutate(year = year(month)) # year column
  # add in temp_file to total file
  homicide_data <- bind_rows(homicide_data, temp_file)
}

# bring in and join ai generated mappings, they look pretty good
mapping <- read.csv("ai_mappings.csv") 

vars <- c(
  median_household_income = "B19013_001",  # Median household income
  total_population        = "B01003_001"   # Total population
)

# Pull ACS data for all variables at county level for MN
years = c(2009, 2014, 2019, 2023)
acs_ts <- map_df(years, function(y) {
  get_acs(
    geography = "county",
    survey = "acs5",
    variables = vars,
    state = "MN",
    year = y,
    geometry = TRUE
  ) |>
    select(GEOID, variable, estimate) |>
    mutate(
      GEOID = as.numeric(GEOID),
      year = y
    ) |>
    pivot_wider(names_from = variable, values_from = estimate)
})

# 2020 estimates https://www.census.gov/programs-surveys/acs/data/experimental-data/1-year.html

homicide_data <- homicide_data|>
    left_join(mapping, by = join_by(ori), relationship = "many-to-many")|> # join in mapping variables
    left_join(acs_ts, by = join_by(GEOID, year))|> # join to acs data by county
    distinct(series, month, .keep_all = TRUE)|> # drop some duplicates left over
    group_by(month)|>drop_na(homicides)|> ungroup() # drop na years
```

```{r}
# collapse data into a form that is able to work with 1 year census data
yearly_large_county_data <- homicide_data |>
  group_by(county, year)|>
  mutate(homicides = sum(homicides))|>
  select(-series, -month, -ori, -type)|>
  distinct()|>
  drop_na(total_population) 

# plot population trends
ggplot(plot_data, aes(x = year, y = total_population, color = county, group = county)) +
  geom_line() +
  geom_point(size = 1) +
  labs(
    title = "Total Population by County over Time",
    x = "Year",
    y = "Total Population",
    color = "County"
  ) +
  theme_minimal()
```

```{r}

```


```{r}
# total ts
homicide_data|> as_tsibble(index = month, key = series)|>
  summarise(homicides = sum(homicides), .groups = "drop") |>
  autoplot()

# yearly ts
homicide_data |> 
  mutate(year = year(month)) |> 
  group_by(year) |> 
  summarise(homicides = sum(homicides), .groups = "drop") |> 
  as_tsibble(index = year) |> 
  autoplot()

# only modern data after 2013 crime reporting changes
homicide_data|> as_tsibble(index = month, key = c(series))|>
  summarise(homicides = sum(homicides), .groups = "drop") |>
  filter(year(month)>=2013)|>
  autoplot()

# only modern data after 2013 crime reporting changes stl decomp
homicide_data|> 
  mutate(month = yearmonth(month))|>
  as_tsibble(index = month, key = c(series))|>
  summarise(homicides = sum(homicides), .groups = "drop") |>
  filter(year(month)>=2013)|>
  model(stl = STL(homicides))|>
  components()|>
  autoplot()
```

