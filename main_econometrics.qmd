```{r imports}
#| verbose: False
#| warning: False
library(tidyverse)
library(tidycensus)
library(fpp3)
library(sf)
library(patchwork)
library(lme4)


acs_1_yearly_data <- readRDS("data/acs_1_yearly_data.rds")
mapping_yearly_data <- readRDS("data/mapping_yearly_data.rds")
crime_data <- readRDS("data/crime_data_merged.rds")
```

```{r homicides_and_pop_spatial_time_series}
#| warning: False
  
plot_census_data <- function(year_to_plot){
  
  map_data <- mapping_yearly_data|>
    filter(year == year_to_plot)
  
  # Plot homicides
  homicides_plot <- ggplot(map_data) +
    geom_sf(aes(fill = homicides), color = "white") +  # white borders between counties
    scale_fill_viridis_c(option = "plasma", trans = "log10", 
                         name = "homicides") +        # log scale for better contrast
    labs(
      title = paste("     Homicides in", year_to_plot),
      caption = "Source: FBI Crime data"
    ) +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none")
  
  # Plot acs 5 pop
  pop5_plot <- map_data|>
    drop_na(total_population_5)|>
    ggplot() +
    geom_sf(aes(fill = total_population_5), color = "white") +  # white borders between counties
    scale_fill_viridis_c(option = "plasma", trans = "log10", 
                         name = "Total Population") +        # log scale for better contrast
    labs(
      title = paste("Population in", year_to_plot),
      caption = "Source: ACS 5 estimates"
    ) +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none")
  
  # Plot acs 1 pop
  pop1_plot <- map_data|>
    ggplot() +
    geom_sf(aes(fill = total_population_1), color = "white") +  # white borders between counties
    scale_fill_viridis_c(option = "plasma", trans = "log10", 
                         name = "Total Population") +        # log scale for better contrast
    labs(
      title = paste("Population in", year_to_plot),
      caption = "Source: ACS 1 estimates"
    ) +
    theme_minimal() +
    theme(axis.text = element_blank(),
          axis.ticks = element_blank(),
          legend.position = "none")
  
  return(pop5_plot + pop1_plot + homicides_plot)
}

# demonstrate the diffs between acs5 and acs1
# showing that homicides rarely occur outside of >65k pop counties
plot_census_data(2008)
plot_census_data(2009)
plot_census_data(2014)
plot_census_data(2019)
plot_census_data(2023)
plot_census_data(2024)

acs_1_yearly_data|>
  group_by(county)|>
  count()|>
  arrange(n)
```

```{r homicides_time_series}
# Monthly totals
monthly_ts <- crime_data |>
  group_by(month) |>
  summarise(homicides = sum(homicides), .groups = "drop") |>
  mutate(type = "Monthly")  # Add type for plotting

# Yearly totals
yearly_ts <- crime_data |>
  group_by(year, county) |>
  summarise(
    population = first(total_population_1),  # take one value per county
    homicides = sum(homicides, na.rm = TRUE),
    .groups = "drop"
  ) |>
  group_by(year) |>
  summarise(
    population = sum(population, na.rm = TRUE),  # now only sum once per county
    homicides = sum(homicides, na.rm = TRUE),
    .groups = "drop"
  ) |>
  mutate(
    month = as.Date(paste0(year, "-01-01")),
    type = "Yearly"
  ) |>
  select(month, homicides, population, type)

# plotting df
combined_ts <- bind_rows(monthly_ts, yearly_ts)



# show the reasons for using yearly data due to how monthly is reported
ggplot(combined_ts, aes(x = month, y = homicides, color = type)) +
  geom_line(size = 1) +
  geom_point(data = subset(combined_ts, type == "Yearly"), size = 2) +  # emphasize yearly points
  scale_color_manual(values = c("Monthly" = "steelblue", "Yearly" = "darkblue")) +
  theme_minimal() +
  labs(title = "Minnesota Homicides Over Time", x = "Date", y = "Homicides", color = "Time Period")



# refactor yearly_ts data to only contain acs1 counties to compare homicide rates to population counts
yearly_ts <- acs_1_yearly_data|>
  group_by(year)|>
  summarise(population = sum(total_population_1),
            homicides_pc = sum(homicides)/sum(total_population_1),
            across(c(arson, assaults, burglary, gta, homicides, larceny, rape, robbery), sum))|>
  mutate(crime_rate = (arson+assaults+burglary+gta+homicides+larceny+rape+robbery)/population)
  


# show homicides vs population relationship
# Compute a scaling factor to map population into homicide scale
yearly_ts <- yearly_ts|>
  mutate(population = ifelse(population == 0, NA, population))|>drop_na()

scale_factor <- max(yearly_ts$homicides, na.rm = TRUE) / max(yearly_ts$population, na.rm = TRUE)

ggplot(yearly_ts, aes(x = year)) +
  # Population line (left axis, true scale)
  geom_line(aes(y = population, color = "Population"), size = 1, linetype = "dashed") +
  geom_point(aes(y = population, color = "Population"), size = 2) +
  
  # Homicides line (right axis, scaled down)
  geom_line(aes(y = homicides / scale_factor, color = "Homicides"), size = 1) +
  geom_point(aes(y = homicides / scale_factor, color = "Homicides"), size = 2) +
  
  scale_y_continuous(
    name = "Population",
    sec.axis = sec_axis(~ . * scale_factor, name = "Homicides")
  ) +
  scale_color_manual(
    values = c("Population" = "firebrick", "Homicides" = "darkblue")
  ) +
  theme_minimal() +
  labs(
    title = "Minnesota Population vs Homicides Over Time for ACS1 Counties",
    x = "Year",
    color = "",
    caption = "Source: ACS1 estimates; using Decennial counts for 2020"
  )


scale_factor <- max(yearly_ts$homicides_pc, na.rm = TRUE) / 
                max(yearly_ts$crime_rate, na.rm = TRUE)

ggplot(yearly_ts, aes(x = year)) +
  # Homicides per capita (true scale, left axis)
  geom_line(aes(y = homicides_pc, color = "Homicides per Capita"), size = 1) +
  geom_point(aes(y = homicides_pc, color = "Homicides per Capita"), size = 2) +
  
  # General crime rate (scaled, right axis)
  geom_line(aes(y = crime_rate * scale_factor, color = "General Crime Rate"), size = 1, linetype = "dashed") +
  geom_point(aes(y = crime_rate * scale_factor, color = "General Crime Rate"), size = 2) +
  
  # Two axes
  scale_y_continuous(
    name = "Homicides per Capita",
    sec.axis = sec_axis(~ . / scale_factor, name = "General Crime Rate")
  ) +
  
  # Colors and labels
  scale_color_manual(
    values = c("Homicides per Capita" = "darkblue", 
               "General Crime Rate" = "purple")
  ) +
  theme_minimal() +
  labs(
    title = "Homicides per Capita vs General Crime Rate (ACS1 Counties)",
    x = "Year",
    color = "",
    caption = "Source: FBI Crime data and ACS1 estimates"
  )



acs_1_yearly_data|>
  ggplot(aes(x = homicides/total_population_1))+
  geom_density()+
  theme_minimal()+
  labs(title = "Density of Minnesota Homicides by County by Year", 
       x = "Homicides per Capita per Year", y = NULL, 
       caption = "Source: FBI Crime data, and ACS1 estimates; using Decennial counts for 2020")

acs_1_yearly_data|>
  ggplot(aes(x = crime_rate))+
  geom_density()+
  theme_minimal()+
  labs(title = "Density of Minnesota Crime Rates by County by Year", 
       x = "Crimes per Capita per Year", y = NULL, 
       caption = "Source: FBI Crime data, and ACS1 estimates; using Decennial counts for 2020")
```

```{r pre_modeling_comparisons}
### vars to calculate stats across for modeling
modeling_vars <- c(
  "homicide_rate", "crime_rate", "periods", "post_covid", "msp_main_counties",
  "officers", "median_household_income", "pct_lessthan_5kincome", 
  "pct_highschool_or_greater", "pct_children_missing_parents", 
  "pct_non_white", "Binge.drinking.prevalence", "pct_young_males", 
  "persons_per_household", "persons_per_m2"
)

### Descriptive stats
means <- acs_1_yearly_data|>summarise(across(modeling_vars, mean))
sds <- acs_1_yearly_data|>summarise(across(modeling_vars, sd))

bind_rows(list(mean = means, sd = sds), .id = "stat")|>
  select(-periods, -post_covid, -msp_main_counties)|>
  pivot_longer(-stat, names_to = "variable", values_to = "value")|>
  pivot_wider(names_from = "stat")

### correlation matrix
target <- "homicide_rate"
lapply(setdiff(modeling_vars, target), function(var) {
  test <- cor.test(
    acs_1_yearly_data[[target]],
    acs_1_yearly_data[[var]],
    method = "pearson"
  )
  data.frame(
    variable = var,
    estimate = test$estimate,
    p.value = test$p.value
  )
}) |> bind_rows()
```

```{r theoretical_model}

# need to ponder if me model is right here
lmer_model <- lmer(homicide_rate ~ median_household_income + pct_non_white + 
                     pct_young_males + post_covid + (1 | county),
                   data = acs_1_yearly_data)


```



















